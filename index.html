<html>
<head>
<title>Follow: For Event Data</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<script type="text/javascript" src="./vendor/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="./vendor/d3.min.js"></script>
<script type="text/javascript" src="./vendor/topojson.js"></script>
<script type="text/javascript" src="./utils/dist-db.js"></script>
<script type="text/javascript" src="./utils/Palette.js"></script>
<script src="./vendor/bootstrap.min.js"></script>

<link href="./vendor/bootstrap.min.css" rel="stylesheet" media="screen">

<style type="text/css">

body {
    background-color: #FCFCFC;
}

#mapContainer {
    z-index: -10;
    left: 0px;
    top: 0px;
    position:absolute;
    background-color: #F0F2FF;
    opacity: 1;
}

.container {
    padding-top: 55px;
    padding-left: 15px;
    padding-right: 15px;
}

.axis {
    position: fixed;
}

.axis path,
.axis line {
    fill: none;
    stroke: black;
    shape-rendering: crispEdges;
}

.brush .extent {
		stroke: #fff;
		fill-opacity: .3;
		shape-rendering: crispEdges;
}

/*
#dateSelector {
    position: fixed;
    display: inline-block;
    background-color: #ffffff;
    opacity: 1;
    width: 555px;
    z-index: 1;
}
*/

#dateSelector {
    position: fixed;
    display: inline-block;
    left: 460px;
    top: 60px;
    background-color: rgb(242, 242, 242);
    opacity:0.9;
    padding: 10px;
    border-color: rgb(212, 212, 212);
    box-shadow: rgba(0, 0, 0, 0.0980392) 0px 0.9090908765792847px 10px 0px;
    color: rgb(51, 51, 51);
    opacity: 0.9;
    /* width: 555px; */
    z-index: 5;
}

#sidebarControls {
    float: left;
    left: 40px;
    top: 60px;
    width: 300px;
    position:fixed;
    z-index: 5;
    background-color: rgb(242, 242, 242);
    opacity:0.9;
    padding: 20px;
    border-color: rgb(212, 212, 212);
    box-shadow: rgba(0, 0, 0, 0.0980392) 0px 0.9090908765792847px 10px 0px;
    color: rgb(51, 51, 51);
}

#timelinesAxis {
    position: fixed;
    /* left: 380px; */
    left: 380px;
    /* top: 50px; */
    /*
    background-color: rgb(242, 242, 242);
    opacity:0.9;
    padding: 5px;
    border-color: rgb(212, 212, 212);
    box-shadow: rgba(0, 0, 0, 0.0980392) 0px 0.9090908765792847px 10px 0px;
    color: rgb(51, 51, 51);
    */
    z-index: 4;
}


#timelinesAxis {
    padding-top: 50px;
}

#timelinesPanel {
    left: 380px;
    top: 130px;
    position:absolute;
}

#chronologyContainer, #interactionsPanel {
    left: 420px;
    top: 130px;
    position:absolute;
}

.selectBox {
	fill: none;
    stroke: black;
    shape-rendering: crispEdges;
}

.tick line {
    stroke: lightgrey;
    opacity: 0.7;
    stroke-width: 1;
}

.subunit {
  	fill: #FCFAF5;
    stroke: #777;
    stroke-linejoin: round;
}

.admin1subunit {
    fill: none;
    opacity: 0.7;
}

.urban-area {
 		fill: #C4C2C3;
}

.urban-area-boundary {
   	fill: #C4C2C3;
}

circle {
    opacity: 0.5;
}

.subunit-boundary {
    fill: none;
    stroke: #000000; /* #777; */
    /* stroke-dasharray: 2,2; */
    stroke-width: 2px;
    stroke-linejoin: round;
}

.admin1-boundary {
    fill: none;
    stroke: #999;
    stroke-width: 1px;
    /* stroke-dasharray: 2,2,1,3,4; */
    stroke-linejoin: round;
}

.subunit-label {
    fill: #777;
    fill-opacity: .5;
    font-size: 20px;
    font-weight: 300;
    text-anchor: middle;
}

.river {
    fill: none;
    stroke: #6978D1;
}

.ocean {
    fill: #6978D1;
}

.place, .place-label {
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    font-size: 10px;
    fill: #444;
}

/*
.logo-main {
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    font-size: 50px;
    fill: #444;
    line-height: 110%;
}

.logo-sub {
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    font-size: 20px;
    fill: #444;
    line-height: 110%;
}
*/

#chronology {
    margin-left: 10px;
    /* width: 545px; */
}

.chronology-item {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 14px;
  margin-bottom: 12px;
  line-height: 120%;
}

.current-country-item {
    background-color: #EDEEF5;
}

.modal, .modal.fade.in {
    top: 0;
}

.background {
    fill: none;	
}

#circleGroup {
    fill: none;
}

path.link {
  fill: none;
  stroke: #666;
  /* stroke-width: 1.5px; */
}


</style>
</head>
<body>
<div id="sidebarControls">
	<form id="queryForm"> 
		<span>
			<div>
				<div>
					<span class="label" style="margin-bottom:5px;">Search:</span><br/>
					<input type="text" id="inputDescription">
					<br/>
				</div>
				<span class="label" style="margin-bottom:5px;">Incident Type:</span><br/>
				<div id="selectIncidentType"></div>
				<br/>
				<div id="countryName"></div>

			</div>
		</div>
		</span>
	</form>	
</div>

<div class="container">

<div class="row">
	<div class="span12">
		<div class="navbar navbar-fixed-top">
  			<div class="navbar-inner">
    			<span class="brand">FOLLOW: For Event Data</span>
				<ul class="nav pull-right">
					<li class="dropdown">
    					<a href="#" class="dropdown-toggle" data-toggle="dropdown">
					    	Options
      						<b class="caret"></b>
    					</a>
					    <ul class="dropdown-menu">
					      <li><a href="javascript:fatalitySizing = !fatalitySizing;map.redrawCompletely();timelines.redrawCompletely();">Toggle size by fatalities</a></li>
					    </ul>
  					</li>
  					<li><a href="#load-data" data-toggle="modal">Select Country</a></li>
  					<li><a href="#about" data-toggle="modal">About</a></li>
				</ul>
		        <form class="navbar-form form-inline">
		            <div class="btn-group" data-toggle="buttons-radio">
		            	<a href="#map" role="button" class="btn active" data-toggle="tab">Map</a>
		            	<a href="#timelines" role="button" class="btn" data-toggle="tab">Timeline</a>
		            	<a href="#chronology" role="button" class="btn" data-toggle="tab">Chronology</a>
		            	<!-- <a href="#interactions" role="button" class="btn" data-toggle="tab">Interactions</a> -->
		            </div>
		        </form>
  			</div>
		</div>
	</div>
</div>

<div>
	<div> 

		<div id="dateSelector"></div>

		<div class="tab-content">
			
			<div class="tab-pane" id="timelines"></div>
		  	
		  	<div class="tab-pane active" id="map"></div>

		  	<div class="tab-pane" id="chronology"></div>

<!--
		  	<div class="tab-pane" id="interactions">
		  		<div id="interactionsPanel"></div>
		  	</div>
-->
		
		</div>

	</div>

</div>


<div id="load-data" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
		<h3 id="myModalLabel">Select Country</h3>
	</div>
	<div class="modal-body">
		<p>Select a country and click "load" to get data and maps for a different country. This may take a few seconds.</p>
		<div id="countrySelector">
			<label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Algeria" unchecked>Algeria</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Angola" unchecked>Angola</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Benin" unchecked>Benin</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Botswana" unchecked>Botswana</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Burkina_Faso" unchecked>Burkina Faso</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Burundi" unchecked>Burundi</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Cameroon" unchecked>Cameroon</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Central_African_Republic" unchecked>Central African Republic</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Chad" unchecked>Chad</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Democratic_Republic_of_the_Congo" unchecked>Democratic Republic of the Congo</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Djibouti" unchecked>Djibouti</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Egypt" unchecked>Egypt</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Equatorial_Guinea" unchecked>Equatorial Guinea</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Eritrea" unchecked>Eritrea</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Ethiopia" unchecked>Ethiopia</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Gabon" unchecked>Gabon</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Gambia" unchecked>Gambia</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Ghana" unchecked>Ghana</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Guinea-Bissau" unchecked>Guinea-Bissau</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Guinea" unchecked>Guinea</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Ivory_Coast" unchecked>Ivory Coast</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Kenya" unchecked>Kenya</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Lesotho" unchecked>Lesotho</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Liberia" unchecked>Liberia</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Libya" unchecked>Libya</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Madagascar" unchecked>Madagascar</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Malawi" unchecked>Malawi</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Mali" unchecked>Mali</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Mauritania" unchecked>Mauritania</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Morocco" unchecked>Morocco</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Mozambique" unchecked>Mozambique</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Namibia" unchecked>Namibia</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Niger" unchecked>Niger</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Nigeria" unchecked>Nigeria</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Republic_of_Congo" unchecked>Republic of Congo</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Rwanda" unchecked>Rwanda</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Senegal" unchecked>Senegal</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Sierra_Leone" unchecked>Sierra Leone</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Somalia" unchecked>Somalia</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="South_Africa" unchecked>South Africa</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="South_Sudan" unchecked>South Sudan</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Sudan" unchecked>Sudan</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Swaziland" unchecked>Swaziland</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Tanzania" unchecked>Tanzania</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Togo" unchecked>Togo</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Tunisia" unchecked>Tunisia</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Uganda" unchecked>Uganda</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Zambia" unchecked>Zambia</label><label class="radio"><input type="radio" name="countryOptionsRadios" id="countryOptions" value="Zimbabwe" unchecked>Zimbabwe</label>
		</div>
	</div>
	<div class="modal-footer">
    	<button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
    	<button class="btn btn-primary" onclick="getRadioButtonValueAndLoad();">Load</button> 
  	</div>
</div>

<div id="about" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myAboutModalLabel" aria-hidden="true">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
		<h3 id="myAboutModalLabel">About</h3>
	</div>
	<div class="modal-body">

		<h4>About the web site</h4>

		<p>This web site was developed by <a href="http://github.com/wija">Bill Abresch</a> at <a href="http://www.hackerschool.com">Hacker School</a>. The source code is available on <a href="https://github.com/wija/follow">GitHub</a> and builds on <a href="http://twitter.github.io/bootstrap/">bootstrap</a>, <a href="http://d3js.org/">d3</a>, <a href="https://github.com/wija/json-database.js">json-database</a>, and <a href="https://github.com/mbostock/topojson">topojson</a>.</p>

		<h4>About the data</h4>

		<p>The data displayed here are from the <a href="http://www.acleddata.com/">Armed Conflict Location and Event Dataset (ACLED)</a> that has been
		developed and maintained by political scientists at Trinity College Dublin. Their dataset on Africa includes
		nearly 70,000 events that took place between 1997 and early 2013.</p>
		<p>ACLED requests that the data be cited as:</p>

		<pre>Raleigh, Clionadh, Andrew Linke, Håvard Hegre and Joakim Karlsen. 2010. Introducing ACLED-Armed Conflict Location and Event Data. Journal of Peace Research 47(5) 1-10.</pre>

		<h4>About the maps</h4>

		<p>The maps are based on shape files from the <a href="http://www.naturalearthdata.com/">Natural Earth</a> project and were generated by <a href="https://github.com/wija/follow/tree/master/scripts">scripts</a> using <a href="http://www.gdal.org/ogr2ogr.html">ogr2ogr</a> and topojson.</p>

	</div>
	<div class="modal-footer">
    	<button class="btn" data-dismiss="modal" aria-hidden="true">Ok</button>
  	</div>
</div>

</div> <!-- closes <div class="container"> -->

<script type="text/javascript">

p = new Palette();
dateFormat = d3.time.format("%x");

//was 700x420
mapWidth = window.innerWidth + 150;
mapHeight = mapWidth * 0.6;

startDate = null;
endDate = null;

fatalitySizing = true;

selectedTab = "#map";

masterCachedResultArr = [];
function redraw(country, resultArr) {
	switch(selectedTab) {
		case "#map":
			map.redraw(resultArr);
			break;
		case "#timelines":
			timelines.redraw(resultArr);
			break;
		case "#chronology":
			table.redraw(resultArr);
			break;
		case "#interactions":
			graphView.redraw(resultArr, country);
			//interactionsTable.redraw(resultArr, country);	
			break;
		case "#country-selector":
			break;
	}

	masterCachedResultArr = resultArr;
}

function redrawOnTabSwitch(country) {
	switch(selectedTab) {
		case "#map":
			map.redraw(masterCachedResultArr);
			break;
		case "#timelines":
			timelines.redraw(masterCachedResultArr);
			break;
		case "#chronology":
			table.redraw(masterCachedResultArr);
			break;
		//case "#interactions":
		//	graphView.redraw(masterCachedResultArr, country);
			//interactionsTable.redraw(masterCachedResultArr, country);	
			break;
		case "#country-selector":
			break;
	}
}

firstTime = true;
loadNewCountry("Algeria");

function loadNewCountry(country) {
	
	if(!firstTime) {
		controls.destruct();
		timelines.destruct();
		map.destruct();
		table.destruct();
		//interactionsTable.destruct();
		//graphView.destruct();
	}

	loadDataset(country, 
				mapHeight, mapWidth, 
				redraw.bind(null, country),
				function() {
					map = new Map(country, 
								  mapWidth, mapHeight, 
								  "map", 
								  function() {
								  		timelines = new Timelines("timelines", 
								  								  new Date("1/1/1997"), 
								  								  new Date("2/28/2013"),
								  								  country);
								  		table = new Table("chronology", country);
								  		//interactionsTable = new InteractionsTable("#interactionsPanel", country);
										//graphView = new GraphView("#interactionsPanel", country);
										controls = new Controls(ps, country);
										controls.attachEventHandlers();
										if(firstTime) {
											//this is broken for some reason, so inserted directly into
											//the html
											//makeCountryList("countrySelector");
											firstTime = false;
										}
										$('a[data-toggle="tab"]').on('shown', function (e) {
  											selectedTab = e.target.attributes.href.value;
  											redrawOnTabSwitch(country);
										});
										$('#load-data').modal('hide');

								  });
				});

}
//CountryList.js

//parentElement = "countrySelector"

function makeCountryList(parentElement) {
	
	var countryList = ["Algeria", "Angola", "Benin", "Botswana", "Burkina Faso", "Burundi", "Cameroon", 
		"Central African Republic","Chad", "Democratic Republic of the Congo", "Djibouti", "Egypt", 
		"Equatorial Guinea", "Eritrea", "Ethiopia","Gabon", "Gambia", "Ghana", "Guinea-Bissau", "Guinea", 
		"Ivory Coast", "Kenya", "Lesotho", "Liberia", "Libya", "Madagascar", "Malawi", "Mali", 
		"Mauritania", "Morocco", "Mozambique", "Namibia", "Niger", "Nigeria", "Republic of Congo", 
		"Rwanda", "Senegal", "Sierra Leone", "Somalia", "South Africa", "South Sudan", "Sudan", 
		"Swaziland", "Tanzania", "Togo", "Tunisia", "Uganda", "Zambia", "Zimbabwe"];

		var s = document.getElementById(parentElement);
		var htmlStr = "";
		for(var i = 0; i < countryList.length; i++) {
			htmlStr += '<label class="radio">'
						+ '<input type="radio" name="countryOptionsRadios" id="countryOptions" value="' + countryList[i].replace(/ /g,'_') + '" unchecked>'
						+ countryList[i]
						+ '</label>';
		}
		s.innerHTML = htmlStr;

/*
	var s ="";
	countryList.forEach(function(v) { 
		s += "<div><a onclick=\"loadNewCountry('" + v.replace(/ /g, "_") + "');\">" + v + "</a></div>"; 
	});
*/
	document.getElementById(parentElement).innerHTML = s;
}

function getRadioButtonValueAndLoad() {
	var radios = document.getElementsByName("countryOptionsRadios");

	for (var i = 0, length = radios.length; i < length; i++) {
	    if (radios[i].checked) {
	    	loadNewCountry(radios[i].value.replace(/ /g, "_"));
	    }
	}
}
//loadDataset.js

//dataset left global for now

function loadDataset(country, mapHeight, mapWidth, qtCallback, callback) {

	var jsonArray,
		jsonReady;

	$(window).unbind('JSONready');

	$.getJSON('data/' + country + '.json', function(response) {

		/* hacky way to jitter the points because too much overlap due to imprecise coordinates */
		var lonJitterBase = 0.01 * mapWidth,
			latJitterBase = 0.01 * mapHeight;
		for(var i = 0, n = response.length; i < n; i++) {
				response[i].LATITUDE_JITTER = (Math.random() - 0.5) * latJitterBase;
				response[i].LONGITUDE_JITTER = (Math.random() - 0.5) * lonJitterBase;
		}

   		jsonArray = response;
   		$(window).trigger('JSONready');
	});

	jsonReady = $(window).on('JSONready', function() {

		dataset = new db.Collection();

		dataset.loadData(

		  jsonArray,

			  { FATALITIES:  		{ index: db.NumberIndex },
			    COUNTRY:     		{ index: db.CategoryIndex },
			    ADM_LEVEL_1_BY_COUNTRY: { index: db.CategoryIndex,
			    					  	  opts: { keyExtractor: function(o) { return o.COUNTRY + '|' + o.ADM_LEVEL_1; }}}, 
			    EVENT_DATE:  		{ index: db.DateIndex }, 
			    EVENT_TYPE:  		{ index: db.CategoryIndex },
			    CONSOLIDATED_NOTES: { index: db.TextIndex }});

		ps = new db.QueryTemplate(

			dataset, 

			db.qtIntersect(
				db.qtField("EVENT_TYPE"), 
				db.qtField("EVENT_DATE"),
				db.qtField("CONSOLIDATED_NOTES")),

			qtCallback);

		callback();
	});
}//Map.js

!function(scope) {

function Map(country, mapWidth, mapHeight, parentElement, callback) {

	this.mapWidth = mapWidth;
	this.mapHeight = mapHeight;

	this.cachedResultArr = [];

	var filename = country + ".json";

	var self = this;


	d3.json("maps/" + filename, function(error, jsonMap) {

	 	var subunits = topojson.object(jsonMap, jsonMap.objects.subunits),
	 		admin1 = topojson.object(jsonMap, jsonMap.objects.admin1),
	    	places = topojson.object(jsonMap, jsonMap.objects.places),
	   		rivers = topojson.object(jsonMap, jsonMap.objects.rivers),
	   		oceans = topojson.object(jsonMap, jsonMap.objects.oceans),
	   		urbanAreas = topojson.object(jsonMap, jsonMap.objects.urban);

		/*
			Re meaning of d3's scale and translate, in addition to the docs, see
			http://stackoverflow.com/questions/14492284/center-a-map-in-d3-given-a-geojson-object
			https://groups.google.com/forum/#!msg/d3-js/pvovPbU5tmo/NNVOC8cIPjUJ
			http://bl.ocks.org/mbostock/4707858
		*/


		self.projection = d3.geo.mercator()
		      .scale(1)
		      .translate([0, 0]);

		var path = d3.geo.path()
		    .projection(self.projection);

		var width = window.innerWidth,
		    b = path.bounds(subunits),
		    s = 1 / ((b[1][0] - b[0][0]) / width),
		    height = s * (b[1][1] - b[0][1]),
		    t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2];

		self.projection
			.scale(s)
		    .translate(t);

		self.svgMap = d3.select('#' + parentElement).append("svg")
		    .attr("width", width)
		    .attr("height", height)
		    .attr("id", "mapContainer");

		self.svgMap.selectAll(".subunit")
			.data(subunits.geometries)
		.enter().append("path")
			.attr("class", function(d) { return "subunit " + d.id; })
			.attr("d", path);

		self.svgMap.selectAll(".river")
			.data(rivers.geometries)
		.enter().append("path")
			.attr("class", "river")
			.attr("style", function(d) { return "stroke-width:" + (d.properties.strokeweig * 2.5);})
			.attr("d", path);

		self.svgMap.selectAll(".urbanArea")
			.data(urbanAreas.geometries)
		.enter().append("path")
			.attr("class", "urban-area")
		  	.attr("d", path);

	  	//is this part necessary?
	  	self.svgMap.append("path")
	    	.datum(topojson.mesh(jsonMap, jsonMap.objects.urban, function(a, b) { return a !== b; }))
	    	.attr("d", path)
	    	.attr("class", "urban-area-boundary");

		self.svgMap.append("path")
			.datum(topojson.mesh(jsonMap, jsonMap.objects.subunits, function(a, b) { return a !== b; }))
			.attr("d", path)
			.attr("class", "subunit-boundary");

		self.svgMap.selectAll(".admin1subunit")
			.data(admin1.geometries)
		.enter().append("path")
			.attr("class", function(d) { return "admin1subunit " + d.id; })
			.attr("d", path);

		self.svgMap.append("path")
			.datum(topojson.mesh(jsonMap, jsonMap.objects.admin1, function(a, b) { return a !== b; }))
			.attr("d", path)
			.attr("class", "admin1-boundary");

		self.svgMap.append("path")
			.datum(places)
			.attr("d", path)
			.attr("class", "place");

		self.svgMap.selectAll(".place-label")
			.data(places.geometries)
		.enter().append("text")
			.attr("class", "place-label")
			.attr("transform", function(d) { return "translate(" + self.projection(d.coordinates) + ")"; })
			.attr("x", function(d) { return d.coordinates[0] > -1 ? 6 : -6; })
			.attr("dy", ".35em")
			.style("text-anchor", function(d) { return d.coordinates[0] > -1 ? "start" : "end"; })
			.text(function(d) { return d.properties.name; });

		self.svgMap.append("g")
			.attr("id", "circleGroup");

		callback();

	});
}

Map.prototype.redraw = function(resultArr) {
		
	var diffs = db.sets.complements(this.cachedResultArr, resultArr),
		enter = diffs[0],
		exit = diffs[1];

	var svgMapNode = document.getElementById("circleGroup");

	var enterFragment = document.createDocumentFragment();

	for(var i = 0, n = enter.length; i < n; i++) {
		
		var d = enter[i]; 
		var proj = this.projection([d.LONGITUDE, d.LATITUDE]);

		var circle = document.createElementNS(svgMapNode.namespaceURI, "circle");
		circle.setAttributeNS(null, "id", d.MY_EVENT_ID);
		circle.setAttributeNS(null, "data-fatalities", d.FATALITIES);
		circle.setAttributeNS(null, "cy", proj[1] + d.LATITUDE_JITTER);
		circle.setAttributeNS(null, "cx", proj[0] + d.LONGITUDE_JITTER);
		if(fatalitySizing) {
			circle.setAttributeNS(null, "r", Math.log(d.FATALITIES+1)*2 + 2);
		} else {
			circle.setAttributeNS(null, "r", 4);
		}
		circle.setAttributeNS(null, "fill", p.getColor(d.EVENT_TYPE));

		//this doesn't result in tooltips actually displaying; why not?
		var titleTextElement = document.createElementNS(svgMapNode.namespaceURI, "text");
		titleTextElement.textContent = d.CONSOLIDATED_NOTES;
		circle.appendChild(titleTextElement);
		
		enterFragment.appendChild(circle);
	}

	svgMapNode.appendChild(enterFragment);

	for(var i = 0, n = exit.length; i < n; i++) {
		var d = exit[i];
		svgMapNode.removeChild(document.getElementById(d.MY_EVENT_ID));
	}

	this.cachedResultArr = resultArr;
}

Map.prototype.redrawCompletely = function() {
	var cs = document.getElementById("circleGroup").childNodes;
	for(var i = 0, n = cs.length; i < n; i++) {
		cs[i].setAttribute("r", fatalitySizing ? Math.log(+cs[i].getAttribute("data-fatalities") + 1) * 2 + 2 : 3);
	}
}

Map.prototype.destruct = function() {
	this.svgMap.remove();
}

scope.Map = Map;

}(window);

//Timelines.js

function Timelines(parentElement, startDate, endDate, country) {

	this.cachedResultArr = [];

	this.axisElement = document.createElement("div");
	this.axisElement.setAttribute("id", "timelinesAxis");
	document.getElementById(parentElement).appendChild(this.axisElement);

	this.panelElement = document.createElement("div");
	this.panelElement.setAttribute("id", "timelinesPanel");
	document.getElementById(parentElement).appendChild(this.panelElement);

	//has devolved into magic numbers at this point
	//currently duplicated in Controls.js
	this.dimensions = { width: window.innerWidth - 400, height: 40 };  //height=40 was for rendering each separately
	this.padding = { outerPaddingWidth: 20, placenameWidth: 70, innerPaddingWidth: 5,
   				   outerPaddingHeight: 2, labelHeight: 10, tickToLabelHeight: 3, tickHeight: 5, 
   				   axisToIncidentsHeight: 5 };
	this.corners = { xTimelineLeft: this.padding.outerPaddingWidth + this.padding.placenameWidth + this.padding.innerPaddingWidth,
   				     xTimelineRight: this.dimensions.width - this.padding.outerPaddingWidth,
   				     yTimelineTop: this.padding.outerPaddingHeight,
   				     yTimelineBottom: this.dimensions.height - (this.padding.outerPaddingHeight + this.padding.labelHeight + this.padding.tickToLabelHeight + this.padding.tickHeight) };

	this.countryOffsets = {};
	
	var cnames = dataset.indexRegistry.ADM_LEVEL_1_BY_COUNTRY.getValues().sort();
	var onlyForCountry = cnames.filter(function(ca) { return ca.split("|")[0].replace(/ /g, '_') === country; });
	var withoutCountry = cnames.filter(function(ca) { return ca.split("|")[0].replace(/ /g, '_') !== country; });
	cnames = onlyForCountry.concat(withoutCountry);
	for(var i = 0, n = cnames.length; i < n; i++) {
		this.countryOffsets[cnames[i]] = 20 + i * this.dimensions.height;
	}
	var maxOffset = 20 + i * this.dimensions.height;

	var totalHeight = maxOffset + 20 - 10;

	var self = this;
	var xScale = (function() {
		return d3.time.scale()
					  .domain([startDate.getTime(), endDate.getTime()])
	            	  .range([self.corners.xTimelineLeft, self.corners.xTimelineRight])
	            	  .clamp(true);
	})();

	this.chart = d3.select(this.panelElement).append("svg")
					.attr("class", "chart")
					.attr("width", this.dimensions.width) //this.dimensions.width)
					.attr("height", totalHeight);

	var splitCnames = cnames.map(function(s) { return s.split('|'); });

	for(var i = 0, n = cnames.length; i < n; i++) {
		this.chart.append("text")
			.text(splitCnames[i][1])
			.attr("x", this.padding.outerPaddingWidth + 5)
			.attr("y", 30 + i * this.dimensions.height + (this.dimensions.height / 3))
			.attr("font-size", this.dimensions.height / 4)
			.attr("font-family", "sans-serif")
			.attr("font-weight", "bold");
		this.chart.append("text")
			.text(splitCnames[i][0])
			.attr("x", this.padding.outerPaddingWidth + 5)
			.attr("y", 30 + i * this.dimensions.height + 2 * (this.dimensions.height / 3))
			.attr("font-size", this.dimensions.height / 4)
			.attr("font-family", "sans-serif");
    }

	this.axisBox = d3.select(this.axisElement).append("svg")
					//.attr("class", "chart")
					.attr("left", self.corners.xTimelineRight)
					.attr("width", self.dimensions.width) //self.corners.xTimelineRight - self.corners.xTimelineLeft)
					.attr("height", 55);

	this.tl = this.axisBox.append("g")
		.attr("class", "axis")
		.attr("transform", "translate(0,45)") //+ (maxOffset + this.corners.yTimelineBottom) + ")")
		.style("font-size", this.padding.labelHeight)
		.style("font-family", "sans-serif");

	this.tl.call(d3.svg.axis()
		.scale(xScale)
		.tickFormat(d3.time.format("%b %Y"))
		.ticks(5)
		.orient("top")
		.tickSize(-10) //(-totalHeight)
		//.tickSize(this.padding.tickHeight)
		.tickPadding(this.padding.tickToLabelHeight));
}

Timelines.prototype.redraw = function(resultArr) {
		
	var diffs = db.sets.complements(this.cachedResultArr, resultArr),
		enter = diffs[0],
		exit = diffs[1];

	var self = this;

	var xScale = (function() {
		return d3.time.scale()
				.domain([startDate, endDate])
	    		.range([self.corners.xTimelineLeft, self.corners.xTimelineRight])
				.clamp(true);
	})();

    this.tl.call(d3.svg.axis()
		.scale(xScale)
		.tickFormat(d3.time.format("%b %Y"))
		.ticks(5)
		.orient("top")
		.tickSize(-10) //(-totalHeight)
		//.tickSize(this.padding.tickHeight)
		.tickPadding(this.padding.tickToLabelHeight));


	var cs = this.chart.selectAll("circle")
				  .data(resultArr, function(d) { return d.MY_EVENT_ID; });

	cs.enter().insert("circle")
		.attr("cx", function(d, i) { return xScale(dateFormat.parse(d.EVENT_DATE).getTime()); })
		.attr("cy", function(d) { return self.countryOffsets[d.COUNTRY+'|'+d.ADM_LEVEL_1] + self.corners.yTimelineBottom - self.padding.axisToIncidentsHeight; })
		.attr("r", function(d) { return fatalitySizing ? Math.log(+d.FATALITIES+1)*2 + 2 : 3; })
		.attr("fill", function(d) { return p.getColor(d.EVENT_TYPE); })
		.append("title").text(function(d) { return d.CONSOLIDATED_NOTES; });

    cs.attr("cx", function(d, i) { 
    	return xScale(dateFormat.parse(d.EVENT_DATE).getTime()); 
    });

	cs.exit().remove();

	this.cachedResultArr = resultArr;

}

Timelines.prototype.redrawCompletely = function() {
	this.chart.selectAll("circle")
		.attr("r", function(o) { return fatalitySizing ? Math.log(+o.FATALITIES+1)*2 + 2 : 3; });
}

Timelines.prototype.destruct = function() {
	this.axisElement.remove();
	this.panelElement.remove();
}


//Table.js

function Table(parentElement, country) {

	this.parentElement = parentElement;
	this.country = country;

	this.cachedResultArr = [];
	
	this.tableContainer = document.createElement("div");
	this.tableContainer.setAttribute("id", "chronologyContainer");
	this.tableContainer.style.width = window.innerWidth - 460;
	document.getElementById(this.parentElement).appendChild(this.tableContainer);
}

Table.prototype.redraw = function(resultArr) {
	
	var diffs = db.sets.complements(this.cachedResultArr, resultArr),
		enter = diffs[0],
		exit = diffs[1];

	var insertFunction = removeToInsertLater(this.tableContainer),
		htmlCollect = this.tableContainer.children;
	for(var i = 0, n = enter.length; i < n; i++) {
		var newDiv = makeNewDiv.call(this, enter[i]);
		for(var j = 0, m = htmlCollect.length; j < m; j++) {
			if(new Date(enter[i].EVENT_DATE).getTime() < htmlCollect[j].getAttribute("data-milliseconds")) {
				this.tableContainer.insertBefore(newDiv, htmlCollect[j]);
				break;
			}
		}
		if(j === m) {
			this.tableContainer.appendChild(newDiv);
		}
	}
	insertFunction();

	for(var i = 0, n = exit.length; i < n; i++) {
		this.tableContainer.removeChild(this.tableContainer.children.namedItem(exit[i].MY_EVENT_ID));
	}

	this.cachedResultArr = resultArr;
}

Table.prototype.destruct = function() {
	document.getElementById(this.parentElement).removeChild(this.tableContainer);
}

function makeNewDiv(o) {

	var newDiv = document.createElement("div");
	newDiv.setAttribute("id", o.MY_EVENT_ID);
	newDiv.setAttribute("data-milliseconds", new Date(o.EVENT_DATE).getTime());
	if(o.COUNTRY.replace(/ /g, '_') === this.country) {
		newDiv.setAttribute("class", "chronology-item current-country-item");
 	} else {
		newDiv.setAttribute("class", "chronology-item");
	}
	var Act1Act2DescSrc = o.CONSOLIDATED_NOTES.split("|");
	var newContent = "<b>" + o.EVENT_DATE
				   + " (" + o.COUNTRY + ", " + o.ADM_LEVEL_1 + ")</b><br/>"
				   + "<i>Description:</i> " + Act1Act2DescSrc[2] + "<br/>"
				   + (Act1Act2DescSrc[0] === "" 
				   		? "" 
				   		: "<i>Actors</i>: " + Act1Act2DescSrc[0]
				   		  + (Act1Act2DescSrc[1] === ""
				   		  		? "<br/>"
				   		  		: " & " + Act1Act2DescSrc[1] + "<br/>")) 
				   + "<i>Source:</i> " +  Act1Act2DescSrc[3] + "<br/>";
	newDiv.innerHTML = newContent;
	return newDiv;
}

//InteractionsTable.js

function InteractionsTable(parentElement, country) {

	//tab must be visible for svg to render and getBBox() work
	$('a[href="#interactions"]').tab('show');


	var actor1 = {},
		actor2 = {},
		dyadicPairs = {};

	for(var i = 0, n = dataset.completeDataArray.length; i < n; i++) {
		if(dataset.completeDataArray[i].COUNTRY === country) {

/*
    <foreignObject width="200" height="200" 
     requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility">
      <p xmlns="http://www.w3.org/1999/xhtml">Text goes here</p>
    </foreignObject>
*/

			var joinedPair = [dataset.completeDataArray[i].ACTOR1, dataset.completeDataArray[i].ACTOR2].join('|');

			dyadicPairs[joinedPair] = 
				dyadicPairs[joinedPair] 
					? dyadicPairs[joinedPair] + 1 
					: 1;

			actor1[dataset.completeDataArray[i].ACTOR1] = true;
			actor2[dataset.completeDataArray[i].ACTOR2] = true;

		}
	}

	var maxIncidentCount = 0;
	for(var v in dyadicPairs) {
		if(dyadicPairs[v] > maxIncidentCount) {
			maxIncidentCount = dyadicPairs[v];
		}
	}

	var actor1Keys = Object.keys(actor1).sort(),
		actor2Keys = Object.keys(actor2).sort();

	this.tester = d3.select(parentElement).append("svg")
					.attr("width", 500)
					.attr("height", 20);

	this.tester.selectAll("text")
			.data(actor1Keys)
		.enter()
			.append("text")
			.text(function(d) { return d; })
			.attr("x", 0)
			.attr("y", 20)
			.attr("font-size", 10)
			.attr("font-family", "sans-serif")
			.attr("font-weight", "bold");

	var maxTextWidthActor1 = 0;
	this.tester.selectAll("text").each(function() {
		if(this.getBBox().width >  maxTextWidthActor1) maxTextWidthActor1 = this.getBBox().width;
	});

	this.tester.remove();

	this.tester = d3.select(parentElement).append("svg")
					.attr("width", 500)
					.attr("height", 20);

	this.tester.selectAll("text")
			.data(actor2Keys)
		.enter()
			.append("text")
			.text(function(d) { return d === "" ? "None" : d; })  //is this working?
			.attr("x", 0)
			.attr("y", 20)
			.attr("font-size", 10)
			.attr("font-family", "sans-serif")
			.attr("font-weight", "bold");

	var maxTextWidthActor2 = 0;
	this.tester.selectAll("text").each(function() {
		if(this.getBBox().width >  maxTextWidthActor2) maxTextWidthActor2 = this.getBBox().width;
	});

	this.tester.remove();



	this.gap = 20;

	this.table = d3.select(parentElement).append("svg")
					.attr("width", maxTextWidthActor2 + 20 + this.gap + (actor2Keys.length + 1) * this.gap)
					.attr("height", maxTextWidthActor1 + 20 + this.gap + (actor1Keys.length + 1) * this.gap);

	this.actor1Scale = d3.scale.ordinal()
							.domain(actor1Keys)
							.rangePoints([maxTextWidthActor2 + 20 + this.gap, maxTextWidthActor1 + 20 + actor1Keys.length * this.gap]);

	this.actor2Scale = d3.scale.ordinal()
						.domain(actor2Keys)
						.rangePoints([maxTextWidthActor1 + 20, maxTextWidthActor1 + 20 + actor2Keys.length * this.gap]);

	this.incidentCountScale = d3.scale.linear().domain([0, Math.log(maxIncidentCount + 1) * 2]).range(["white", "red"]);

	var self = this;


	//.attr("text-anchor", "middle")
	this.table.selectAll(".rowHeads")
			.data(actor1Keys)
		.enter()
			.append("text")
			.text(function(d) { return d; })
			.attr("x", maxTextWidthActor1)
			.attr("y", function(d) { return self.actor1Scale(d); })
			.attr("text-anchor", "end")
			.attr("font-size", 10)
			.attr("font-family", "sans-serif")
			.attr("font-weight", "bold");

	this.table.selectAll(".columnHeads")
			.data(actor2Keys)
		.enter()
			.append("text")
			.text(function(d) { return d; })
			//.attr("x", function(d) { return self.actor2Scale(d); })
			//.attr("y", maxTextWidthActor2)
			.attr("text-anchor", "end")
			.attr("font-size", 10)
			.attr("font-family", "sans-serif")
			.attr("font-weight", "bold")
			.attr("transform", function(d) { return "translate(" + self.actor2Scale(d) + "," + maxTextWidthActor2 + ")rotate(90)"; });

/*
	var maxTextWidth = 0;
	this.table.selectAll("text").each(function() {
		if(this.getBBox().width >  maxTextWidth) maxTextWidth = this.getBBox().width;
	});

*/



/*	this.table.selectAll("circle")
			.data(actor1Keys)
				.enter().insert("circle")
				.attr("cx", 5)
				.attr("cy", function(d) { return self.actor1Scale(d); })
				.attr("r", 4)
				.attr("fill", "#fgabfg");

	this.table.selectAll("circle")
			.data(actor2Keys)
				.enter().insert("circle")
				.attr("cx", function(d) { return self.actor2Scale(d); })
				.attr("cy", 5)
				.attr("r", 4)
				.attr("fill", "#fgabfg");
*/
/*
    <foreignObject width="200" height="200" 
     requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility">
      <p xmlns="http://www.w3.org/1999/xhtml">Text goes here</p>
    </foreignObject>
*/

//		.append("title").text(function(d) { return d.CONSOLIDATED_NOTES; });

	//console.log(dyadicPairs);

}

InteractionsTable.prototype.redraw = function(resultArr, country) {

	var dyadicPairs = {};

	for(var i = 0, n = resultArr.length; i < n; i++) {
		if(resultArr[i].COUNTRY === country) {

			var joinedPair = [resultArr[i].ACTOR1, resultArr[i].ACTOR2].join('|');

			dyadicPairs[joinedPair] = 
				dyadicPairs[joinedPair] 
					? dyadicPairs[joinedPair] + 1 
					: 1;
		}
	}

	var self = this;

	var rs = this.table.selectAll("rect")
			.data(d3.entries(dyadicPairs), function(d) { return d.key; });

	rs.enter().insert("rect")
			.attr("x", function(d) { return self.actor2Scale(d.key.split('|')[1]); })
			.attr("y", function(d) { return self.actor1Scale(d.key.split('|')[0]); })
			.attr("width", self.gap)
			.attr("height", self.gap)
			.attr("fill", function(d) { return self.incidentCountScale(Math.log(d.value + 1) * 2); });

	rs.attr("fill", function(d) { return self.incidentCountScale(Math.log(d.value + 1) * 2); });

	rs.exit().remove();

}

InteractionsTable.prototype.destruct = function() {
	this.table.remove();
}
//GraphView.js

function GraphView(parentElement, country) {

	this.width = window.innerWidth - 400;
	this.height = 1000;

	this.svg = d3.select(parentElement).append("svg")
					.attr("width", this.width)
					.attr("height", this.height);


}

//why pass this country instead of it using this.country?
GraphView.prototype.redraw = function(resultArr, country) {

	var dyadicPairs = {},
		nodeList = {},
		linkList = [];

	for(var i = 0, n = dataset.completeDataArray.length; i < n; i++) {
		if(dataset.completeDataArray[i].COUNTRY === country) {

			var joinedPair = [dataset.completeDataArray[i].ACTOR1, dataset.completeDataArray[i].ACTOR2].join('|');

			dyadicPairs[joinedPair] = 
				dyadicPairs[joinedPair] 
					? dyadicPairs[joinedPair] + 1 
					: 1;

			nodeList[dataset.completeDataArray[i].ACTOR1] = true;
			nodeList[dataset.completeDataArray[i].ACTOR2] = true;
		}
	}

	nodeToIndex = {};
	nodeList = Object.keys(nodeList).map(function(n,i) { 
		nodeToIndex[n] = i; 
		return {"name": n};
	});

	console.log(dyadicPairs);
	for(var v in dyadicPairs) {
		var splitPair = v.split('|');
		linkList.push({"source":nodeToIndex[splitPair[0]],"target":nodeToIndex[splitPair[1]],"value":dyadicPairs[v]});
	}

	var force = d3.layout.force()
	    .nodes(nodeList)
	    .links(linkList)
	    .size([this.width, this.height])
	    .gravity(0)
	    .linkDistance(350)
	    .charge(-350)
	    .on("tick", tick)
	    .start();

/*
// Per-type markers, as they don't inherit styles.
svg.append("svg:defs").selectAll("marker")
    .data(["suit", "licensing", "resolved"])
  .enter().append("svg:marker")
    .attr("id", String)
    .attr("viewBox", "0 -5 10 10")
    .attr("refX", 15)
    .attr("refY", -1.5)
    .attr("markerWidth", 6)
    .attr("markerHeight", 6)
    .attr("orient", "auto")
  .append("svg:path")
    .attr("d", "M0,-5L10,0L0,5");
*/


var path = this.svg.append("svg:g").selectAll("path")
    .data(force.links())
  .enter().append("svg:path")
	.attr("class", "link")
	.attr("stroke-width", function(d) { return Math.log(d.value + 1); }); //function(d) { return "link " + d.type; });
//    .attr("marker-end", function(d) { return "url(#" + d.type + ")"; });


var circle = this.svg.append("svg:g").selectAll("circle")
    .data(force.nodes())
  .enter().append("svg:circle")
    .attr("r", 6)
    .call(force.drag);


var text = this.svg.append("svg:g").selectAll("g")
    .data(force.nodes())
  .enter().append("svg:g");

/*
// A copy of the text with a thick white stroke for legibility.
text.append("svg:text")
    .attr("x", 8)
    .attr("y", ".31em")
    .attr("class", "shadow")
    .text(function(d) { return d.name; });
*/

text.append("svg:text")
    .attr("x", 8)
    .attr("y", ".31em")
    .text(function(d) { return d.name.slice(0,10); });

function tick() {
	path.attr("d", function(d) {
	    return "M" + d.source.x + "," + d.source.y + "L" + d.target.x + "," + d.target.y;
	});

    circle.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

    text.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
}

/*
	  path.attr("d", function(d) {
	    var dx = d.target.x - d.source.x,
	        dy = d.target.y - d.source.y,
	        dr = Math.sqrt(dx * dx + dy * dy);
	    return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
	  });

	  circle.attr("transform", function(d) {
	    return "translate(" + d.x + "," + d.y + ")";
	  });

	  text.attr("transform", function(d) {
	    return "translate(" + d.x + "," + d.y + ")";
	  });
*/

}

GraphView.prototype.destruct = function() {
	this.svg.remove();
}
//Controls.js

//need to get date handling under control

//queryTemplate is actually still global (ps)


function Controls(queryTemplate, country) {

	this.queryTemplate = queryTemplate;

	document.getElementById("countryName").innerHTML = '<b>' + country.replace(/_/g, ' ') + '</b><br/>'
														+ 'Use "Select Country" on the menu bar '
														+ '<br/>to view data for other countries.';

	makeCheckBoxes("selectIncidentType", "EVENT_TYPE");

	//has devolved into magic numbers at this point
	//currently duplicated in Controls.js
	this.dimensions = { width: window.innerWidth - 400, height: 40 };  //height=40 was for rendering each separately
	this.padding = { outerPaddingWidth: 5, placenameWidth: 70, innerPaddingWidth: 5,
   				   outerPaddingHeight: 2, labelHeight: 10, tickToLabelHeight: 3, tickHeight: 5, 
   				   axisToIncidentsHeight: 5 };
	this.corners = { xTimelineLeft: this.padding.outerPaddingWidth + this.padding.placenameWidth + this.padding.innerPaddingWidth,
   				   xTimelineRight: this.dimensions.width - this.padding.outerPaddingWidth,
   				   yTimelineTop: this.padding.outerPaddingHeight,
   				   yTimelineBottom: this.dimensions.height - (this.padding.outerPaddingHeight + this.padding.labelHeight + this.padding.tickToLabelHeight + this.padding.tickHeight) };

	var selectorScale = d3.time.scale().range([this.corners.xTimelineLeft - this.padding.placenameWidth, this.corners.xTimelineRight - this.padding.placenameWidth -  this.padding.placenameWidth]),
		selectorAxis = d3.svg.axis().scale(selectorScale).orient("bottom");
	selectorScale.domain([dateFormat.parse("1/1/1997"), dateFormat.parse("2/28/2013")]);

	this.brush = d3.svg.brush()
			  		.x(selectorScale)
			  		.extent([dateFormat.parse("1/1/2011"), dateFormat.parse("1/1/2012")]);

	this.context = d3.select("#dateSelector").append("svg")
		.attr("width", this.dimensions.width)
		.attr("height", 40);

	this.context.append("rect")
		  .classed("selectBox", true)
	      .attr("x", this.corners.xTimelineLeft - this.padding.placenameWidth)
	      .attr("width", this.corners.xTimelineRight - this.corners.xTimelineLeft - this.padding.placenameWidth)
	      .attr("y", 0) 
	      .attr("height", 20);
	     
	this.context.append("g")
	      .attr("class", "axis")
	      .attr("transform", "translate(0," + 20 + ")")
	      .style("font-size", this.padding.labelHeight)
	      .style("font-family", "sans-serif")
	      .call(selectorAxis);

	this.context.append("g")
	      .attr("class", "x brush")
	      .call(this.brush)
	    .selectAll("rect")
	      .attr("y", 1)
	      .attr("height", 18);

	document.getElementById("dateSelector").style.width = this.corners.xTimelineRight - this.corners.xTimelineLeft - this.padding.placenameWidth + 10;

	//not really so great that this calls dataset by name
	function makeCheckBoxes(idName, fieldName) {
		var s = document.getElementById(idName);
		var opts = dataset.indexRegistry[fieldName].getValues().sort();
		var htmlStr = "";
		for(var i = 0; i < opts.length; i++) {
			htmlStr += '<label class="checkbox">'
						+ '<input type="checkbox" data-value="' + opts[i] + '">'
						+ '<svg width="10" height="10">'
						+ '<circle cx="5" cy="5" r="5" fill="' + p.getColor(opts[i]) + '"/>' 
						+ '</svg> '
						+ opts[i]
						+ '</label>';
		}

		s.innerHTML = htmlStr;
		//A dangerous little hack; figure out how bootstrap does checkboxes
		$('input[type="checkbox"]').prop('checked', true);
	}
}

Controls.prototype.destruct = function() {
	//is this necessary? and what about the d3 brush listener?
	document.getElementById("selectIncidentType").removeEventListener("change", this.selectIncidentTypeListener);
	//document.getElementById("fatalitySizing").removeEventListener("change", this.selectIncidentTypeListener);
	document.getElementById("inputDescription").removeEventListener("keyup", this.inputDescriptionListener);
	this.context.remove();
	document.getElementById("inputDescription").value= '';
}

Controls.prototype.attachEventHandlers = function() {

	var self = this;
	this.selectIncidentTypeListener = function() { newMultiSelect(this,self.queryTemplate,"EVENT_TYPE"); };
	this.inputDescriptionListener = function() { newTextInput(this,self.queryTemplate,"CONSOLIDATED_NOTES"); };
/*
	this.fatalitySizingListener = function() {
		if(document.getElementById("fatalitySizing").children[0].children[0].checked) {
			fatalitySizing = true; 
		} else {
			fatalitySizing = false;
		}
		//Note that this happens on all tabs simultaneously
		//May need to queue up changes for unviewed tabs
		map.redrawCompletely();
		timelines.redrawCompletely();
	}
*/
	document.getElementById("selectIncidentType")
		.addEventListener("change", this.selectIncidentTypeListener);

//	document.getElementById("fatalitySizing")
//		.addEventListener("change", this.fatalitySizingListener);

	document.getElementById("inputDescription")
		.addEventListener("keyup", this.inputDescriptionListener);

	this.brush.on("brush", brushed.bind(this));

	self.queryTemplate.evaluate("CONSOLIDATED_NOTES", {selectAll: true});
	self.queryTemplate.evaluate("EVENT_TYPE", {selectAll: true});
	brushed.call(this);

	function newTextInput(inputObj, queryTemplate, label) {
		if(inputObj.value === "") {
			queryTemplate.evaluate(label, {selectAll: true});	
		} else {
			queryTemplate.evaluate(label, {autoCompleteSearch: inputObj.value});
		}
	}

	function newMultiSelect(selectObj, queryTemplate, label) {

		var options = [];
		var child = selectObj.firstChild;

		while(child) {
	    	if(child.children[0].checked) {
	    		options.push(child.children[0].getAttribute("data-value"));
	    	}
	    	
	    	child = child.nextSibling;
		}


		queryTemplate.evaluate(label, {any: options});
	}

	function brushed() {

		var ext = this.brush.extent();

		//made at least temporarily global so can use to calculate scales in Timelines
		startDate = ext[0].getTime(); 
		endDate = ext[1].getTime();
		this.queryTemplate.evaluate("EVENT_DATE", {inRange: [dateFormat(ext[0]), dateFormat(ext[1])]});
	}

}



//dom-utils.js

//from https://developers.google.com/speed/articles/javascript-dom
/**
 * Remove an element and provide a function that inserts it into its original position
 * @param element {Element} The element to be temporarily removed
 * @return {Function} A function that inserts the element into its original position
 **/
function removeToInsertLater(element) {
	var parentNode = element.parentNode;
	var nextSibling = element.nextSibling;
	parentNode.removeChild(element);
	return function() {
		if (nextSibling) {
			parentNode.insertBefore(element, nextSibling);
    	} else {
      		parentNode.appendChild(element);
    	}
  	};
}
</script><script>
  $(function () {
    $('#m a[href="#map"]').tab('show');
  });
 /*
$('a[data-toggle="tab"]').on('shown', function (e) {
  selectedTab = e.target.attributes.href.value;
  redrawOnTabSwitch();
});
*/
</script>

</body>
</html>